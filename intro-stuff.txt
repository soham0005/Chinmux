import re
import tempfile
import subprocess

def extract_bash_script(ai_response):
    script_pattern = r"```bash\n([\s\S]*?)```"
    match = re.search(script_pattern, ai_response)
    return match.group(1).strip() if match else None

def save_and_execute_script(script_content):
    if script_content:
        with tempfile.NamedTemporaryFile(mode='w+', delete=False, suffix='.sh') as temp_file:
            temp_file.write(script_content)
            temp_file_path = temp_file.name

        print(f"Script saved to: {temp_file_path}")
        subprocess.run(['chmod', '+x', temp_file_path])

        try:
            result = subprocess.run(['/bin/bash', temp_file_path], 
                                    capture_output=True, 
                                    text=True, 
                                    check=True)
            print("Script executed successfully.")
            print("Output:", result.stdout)
        except subprocess.CalledProcessError as e:
            print("Error executing the script:")
            print(e.stderr)

def is_execution_command(user_input):
    execution_keywords = ['run', 'execute', 'start', 'perform', 'do', 'launch', 'go', 'begin']
    script_keywords = ['script', 'code', 'command', 'it', 'that']
    
    user_input = user_input.lower()
    
    for exec_word in execution_keywords:
        for script_word in script_keywords:
            if f"{exec_word} {script_word}" in user_input:
                return True
    
    return False

def process_user_input(user_input, script):
    if is_execution_command(user_input):
        print("Script content:")
        print(script)
        confirmation = input("Are you sure you want to run this script? (yes/no): ")
        if confirmation.lower() in ['yes', 'y']:
            save_and_execute_script(script)
        else:
            print("Script execution cancelled.")
    else:
        print("I'm not sure if you want to run the script. You can say 'run script' if you want to execute it.")

# Example usage in a chat loop
ai_response = """
Here's a bash script to update your system:

```bash
#!/bin/bash
sudo apt update
sudo apt upgrade -y
```

Let me know if you want to run this script.
"""

script = extract_bash_script(ai_response)
if script:
    print("AI Assistant: I've prepared a script for you. Let me know if you want to run it.")
    while True:
        user_input = input("You: ")
        if user_input.lower() in ['exit', 'quit', 'bye']:
            break
        process_user_input(user_input, script)
else:
    print("No bash script found in the AI response.")